const axios = require('axios');
const BASE_URL = "http://127.0.0.1:53200"; // Port của iXBrowser

/**
 * Tạo Profile mới
 */
async function createProfile(name) {
    try {
        const body = {
            name: name,
            group_id: 1, 
            site_id: 1, 
            fingerprint_config: {
                ua_type: 2,           // Mobile User Agent
                hide_debug_panel: "1", // Ẩn thanh debug
                platform: "IOS"
            }
        };
        const res = await axios.post(`${BASE_URL}/api/v2/profile-create`, body);
        
        // Fix check success
        const isSuccess = (res.data.code === 0) || (res.data.error && res.data.error.code === 0);
        
        if (isSuccess && res.data.data) {
            console.log(`✅ Đã tạo Profile mới: ID ${res.data.data}`);
            return res.data.data;
        }
        throw new Error(res.data.message || JSON.stringify(res.data));
    } catch (error) {
        console.error("❌ Lỗi tạo profile:", error.message);
        return null;
    }
}

/**
 * Mở Profile với cấu hình Mobile & Random Fingerprint
 */
async function openProfile(profileId) {
    try {
        console.log(`[*] Đang mở Profile ID ${profileId}...`);
        const body = {
            profile_id: parseInt(profileId),
            load_profile_info_page: false,
            fingerprint_config: {
                ua_type: 2,           // Mobile User Agent
                hide_debug_panel: "1" // Ẩn thanh debug
            }
        };
        
        const res = await axios.post(`${BASE_URL}/api/v2/profile-open-with-random-fingerprint`, body);
        
        // Kiểm tra phản hồi (Ưu tiên lấy ws nếu có data)
        if (res.data.data && res.data.data.ws) {
            return res.data.data.ws;
        }
        
        throw new Error(JSON.stringify(res.data));
    } catch (e) {
        console.error("❌ Lỗi API iXBrowser (Open):", e.message);
        return null;
    }
}

/**
 * Đóng Profile
 */
async function closeProfile(profileId) {
    try { 
        await axios.post(`${BASE_URL}/api/v2/profile-close`, { profile_id: parseInt(profileId) });
    } catch (e) {}
}

/**
 * Cập nhật Proxy cho Profile (ĐÃ FIX LỖI CODE 0)
 */
async function updateProxy(profileId, proxyData) {
    try {
        if (!proxyData || !proxyData.http_proxy) {
            throw new Error("Dữ liệu Proxy không hợp lệ");
        }

        const [ip, port] = proxyData.http_proxy.split(':');
        
        const body = {
            profile_id: parseInt(profileId),
            proxy_info: {
                proxy_mode: 2,
                proxy_type: "http",
                proxy_ip: ip,
                proxy_port: port,
                proxy_user: proxyData.username || "",
                proxy_password: proxyData.password || ""
            }
        };
        
        const res = await axios.post(`${BASE_URL}/api/v2/profile-update-proxy-for-custom-proxy`, body);
        
        // [FIX QUAN TRỌNG] Kiểm tra cả 2 trường hợp success
        const isSuccess = (res.data.code === 0) || (res.data.error && res.data.error.code === 0);

        if(isSuccess) {
            console.log(`✅ Đã update proxy [${ip}:${port}] vào Profile ${profileId}`);
            return true;
        } else {
            console.error(`❌ iXBrowser từ chối update proxy:`, JSON.stringify(res.data));
            return false;
        }
    } catch (e) {
        console.error("❌ Lỗi kết nối API update proxy:", e.message);
        return false;
    }
}

module.exports = { createProfile, openProfile, closeProfile, updateProxy };